{% extends "base.html" %}

{% block title %}小说列表 - 小说阅读网站{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <h5>筛选条件</h5>
        
        <!-- 分类筛选 -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">按分类筛选</h6>
                <button class="btn btn-outline-primary btn-sm" onclick="showCategoryManager()">
                    <i class="bi bi-gear-fill"></i> 管理
                </button>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush" id="categoryList">
                    <a href="{{ url_for('novel_list', sort=current_sort) }}" 
                       class="list-group-item list-group-item-action {% if not current_category %}active{% endif %}">
                        全部分类
                    </a>
                    {% for category in categories %}
                    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center {% if current_category == category.id %}active{% endif %}" data-category-id="{{ category.id }}">
                        <a href="{{ url_for('novel_list', category=category.id, sort=current_sort) }}" class="text-decoration-none flex-grow-1">
                            {{ category.name }}
                        </a>
                        <div class="category-actions d-none">
                            <button class="btn btn-outline-warning btn-sm me-1" onclick="editCategory({{ category.id }}, '{{ category.name }}', '{{ category.description }}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCategory({{ category.id }}, '{{ category.name }}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-2">
                    <button class="btn btn-outline-success btn-sm w-100" onclick="showAddCategoryForm()">
                        <i class="bi bi-plus-circle"></i> 添加新分类
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 排序选项 -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">排序方式</h6>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('novel_list', category=current_category, sort='created_at') }}" 
                       class="list-group-item list-group-item-action {% if current_sort == 'created_at' %}active{% endif %}">
                        最新发布
                    </a>
                    <a href="{{ url_for('novel_list', category=current_category, sort='updated_at') }}" 
                       class="list-group-item list-group-item-action {% if current_sort == 'updated_at' %}active{% endif %}">
                        最近更新
                    </a>
                    <a href="{{ url_for('novel_list', category=current_category, sort='avg_rating') }}" 
                       class="list-group-item list-group-item-action {% if current_sort == 'avg_rating' %}active{% endif %}">
                        评分最高
                    </a>
                    <a href="{{ url_for('novel_list', category=current_category, sort='user_rating') }}" 
                       class="list-group-item list-group-item-action {% if current_sort == 'user_rating' %}active{% endif %}">
                        我的评分
                    </a>
                    <a href="{{ url_for('novel_list', category=current_category, sort='favorites', favorites='true') }}" 
                       class="list-group-item list-group-item-action {% if show_favorites %}active{% endif %}">
                        <i class="bi bi-heart-fill text-danger"></i> 我的收藏
                    </a>
                </div>
            </div>
        </div>
        
        <!-- 按日期筛选 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">按日期筛选</h6>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="changeMonth(-1)" title="上一月">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="changeMonth(1)" title="下一月">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="novelCalendar" class="novel-calendar">
                    <div class="calendar-header">
                        <span id="calendarTitle" class="fw-bold"></span>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">日</div>
                            <div class="calendar-weekday">一</div>
                            <div class="calendar-weekday">二</div>
                            <div class="calendar-weekday">三</div>
                            <div class="calendar-weekday">四</div>
                            <div class="calendar-weekday">五</div>
                            <div class="calendar-weekday">六</div>
                        </div>
                        <div id="calendarDays" class="calendar-days">
                            <!-- 日期将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
                {% if current_date %}
                <div class="p-2 bg-light border-top">
                    <small class="text-muted">
                        <i class="bi bi-funnel"></i> 当前筛选: {{ current_date }}
                        <a href="{{ url_for('novel_list', category=current_category, sort=current_sort) }}" class="text-decoration-none ms-2">
                            <i class="bi bi-x-circle"></i> 清除
                        </a>
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <h4 class="me-3">小说列表</h4>
                
                <!-- 排序控件 -->
                <div class="sort-controls d-flex align-items-center">
                    <label class="form-label me-2 mb-0 text-muted">
                        <i class="bi bi-sort-down"></i> 排序：
                    </label>
                    
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-primary btn-sm dropdown-toggle d-flex align-items-center" 
                                type="button" id="sortDropdown" data-bs-toggle="dropdown">
                            <i class="bi bi-funnel me-1"></i>
                            <span id="currentSortText">最新发布</span>
                        </button>
                        <ul class="dropdown-menu shadow" aria-labelledby="sortDropdown">
                            <li><h6 class="dropdown-header"><i class="bi bi-clock-history"></i> 按时间</h6></li>
                            <li><a class="dropdown-item" href="#" data-sort="created_at" data-name="最新发布">
                                <i class="bi bi-calendar-plus text-success"></i> 最新发布 (新→旧)
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-sort="created_at_asc" data-name="最早发布">
                                <i class="bi bi-calendar-minus text-warning"></i> 最早发布 (旧→新)
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header"><i class="bi bi-type"></i> 按名称</h6></li>
                            <li><a class="dropdown-item" href="#" data-sort="title" data-name="名称升序">
                                <i class="bi bi-sort-alpha-down text-info"></i> 名称升序 (A→Z)
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-sort="title_desc" data-name="名称降序">
                                <i class="bi bi-sort-alpha-up text-info"></i> 名称降序 (Z→A)
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header"><i class="bi bi-star"></i> 按评分</h6></li>
                            <li><a class="dropdown-item" href="#" data-sort="rating" data-name="评分最高">
                                <i class="bi bi-star-fill text-warning"></i> 评分最高 (高→低)
                            </a></li>
                            <li><a class="dropdown-item" href="#" data-sort="rating_asc" data-name="评分最低">
                                <i class="bi bi-star text-secondary"></i> 评分最低 (低→高)
                            </a></li>
                            
                            <li><hr class="dropdown-divider"></li>
                            <li><h6 class="dropdown-header"><i class="bi bi-person"></i> 个人</h6></li>
                            <li><a class="dropdown-item" href="#" data-sort="user_rating" data-name="我的评分">
                                <i class="bi bi-heart-fill text-danger"></i> 我的评分
                            </a></li>
                        </ul>
                    </div>
                    
                    <!-- 快速排序按钮组 -->
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary quick-sort-btn" 
                                data-sort="created_at" title="最新发布">
                            <i class="bi bi-clock"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary quick-sort-btn" 
                                data-sort="title" title="按名称排序">
                            <i class="bi bi-sort-alpha-down"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary quick-sort-btn" 
                                data-sort="rating" title="按评分排序">
                            <i class="bi bi-star"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <span class="text-muted">
                {% if novels.total %}
                    共找到 {{ novels.total }} 本小说
                {% endif %}
            </span>
        </div>
        
        {% if novels and novels.items %}
            <!-- 单排列表样式 -->
            <div class="list-group">
                {% for novel in novels.items %}
                <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3">
                    <div class="d-flex flex-column flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <!-- 标题显示/编辑区域 -->
                            <div class="title-container flex-grow-1" data-novel-id="{{ novel.id }}">
                                <h6 class="mb-0 title-display">
                                    <a href="{{ url_for('novel_detail', novel_id=novel.id) }}" class="text-decoration-none">
                                        {{ novel.title }}
                                    </a>
                                    <small class="text-muted ms-2">
                                        <i class="bi bi-calendar-plus text-success"></i>
                                        {{ novel.created_at.strftime('%m-%d') }}
                                        <span class="badge bg-light text-dark ms-1">{{ novel.created_at.strftime('%H:%M') }}</span>
                                    </small>
                                </h6>
                                <div class="title-edit d-none">
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control title-input" value="{{ novel.title }}">
                                        <button class="btn btn-outline-success btn-sm save-title-btn" onclick="saveNovelTitle({{ novel.id }})">
                                            <i class="bi bi-check"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm cancel-edit-btn" onclick="cancelTitleEdit({{ novel.id }})">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- 编辑按钮 -->
                            <button class="btn btn-outline-warning btn-sm ms-2 edit-title-btn" onclick="editNovelTitle({{ novel.id }})" title="编辑标题">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <!-- 删除按钮 -->
                            <button class="btn btn-outline-danger btn-sm ms-1 delete-novel-btn" onclick="confirmDeleteNovel({{ novel.id }}, '{{ novel.title }}')" title="删除小说">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <small class="text-muted">{{ novel.category.name }}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <!-- 用户评分 -->
                        <div class="me-3">
                            <div class="star-rating" data-novel-id="{{ novel.id }}" data-rating="{{ novel.user_rating or 0 }}">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <small class="text-muted d-block text-center">我的评分</small>
                        </div>
                        <span class="badge bg-secondary me-3">
                            {{ "%.1f万字"|format(novel.word_count/10000) if novel.word_count > 10000 else novel.word_count|string + "字" }}
                        </span>
                        <a href="{{ url_for('read_full_novel', novel_id=novel.id) }}" class="btn btn-outline-primary btn-sm">
                            阅读
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- 分页 -->
            {% if novels.pages > 1 %}
            <nav aria-label="小说列表分页">
                <ul class="pagination justify-content-center">
                    {% if novels.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('novel_list', page=novels.prev_num, category=current_category, sort=current_sort) }}">上一页</a>
                        </li>
                    {% endif %}
                    
                    {% for page_num in novels.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != novels.page %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('novel_list', page=page_num, category=current_category, sort=current_sort) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if novels.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('novel_list', page=novels.next_num, category=current_category, sort=current_sort) }}">下一页</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <h5>暂无小说</h5>
                <p class="text-muted">请尝试调整筛选条件</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- 分类管理模态框 -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">分类管理</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId" name="categoryId">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">分类名称</label>
                        <input type="text" class="form-control" id="categoryName" name="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">分类描述</label>
                        <textarea class="form-control" id="categoryDescription" name="categoryDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveCategoryForm()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除小说确认模态框 -->
<div class="modal fade" id="deleteNovelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    危险操作 - 删除小说
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" role="alert">
                    <strong>⚠️ 警告：</strong>此操作不可撤销！删除小说将永久移除以下所有数据：
                    <ul class="mt-2 mb-0">
                        <li>小说的所有章节内容</li>
                        <li>用户对该小说的评分和评论</li>
                        <li>收藏和阅读进度记录</li>
                    </ul>
                </div>
                <p class="mb-3">确定要删除小说：</p>
                <div class="card">
                    <div class="card-body bg-light">
                        <h6 class="card-title text-danger" id="deleteNovelTitle"></h6>
                        <small class="text-muted">ID: <span id="deleteNovelId"></span></small>
                    </div>
                </div>
                <div class="mt-3">
                    <label for="confirmInput" class="form-label">
                        请输入 <strong class="text-danger">"确认删除"</strong> 来确认操作：
                    </label>
                    <input type="text" class="form-control" id="confirmInput" placeholder="输入：确认删除" autocomplete="off">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="executeDeleteNovel()" id="confirmDeleteBtn" disabled>
                    <i class="bi bi-trash-fill me-1"></i>
                    确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除分类确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除分类 "<span id="deleteCategoryName"></span>" 吗？</p>
                <p class="text-danger small">注意：删除分类后，该分类下的所有小说将无法正常显示！</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCategory()">确认删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 日期详情模态框 -->
<div class="modal fade" id="dateDetailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar-event"></i>
                    <span id="modalDateTitle"></span> 添加的小说
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dateNovelsList" class="list-group">
                    <!-- 小说列表将通过JavaScript动态生成 -->
                </div>
                <div id="dateNovelsLoading" class="text-center py-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
                <div id="dateNovelsEmpty" class="text-center py-3 text-muted d-none">
                    该日期没有添加任何小说
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="filterByModalDate()">
                    <i class="bi bi-funnel"></i> 查看此日期的所有小说
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* 月历组件样式 */
.novel-calendar {
    font-size: 13px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.calendar-header {
    text-align: center;
    padding: 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: white;
}

.calendar-weekdays {
    display: contents;
}

.calendar-weekday {
    padding: 10px 4px;
    text-align: center;
    font-weight: bold;
    background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    font-size: 12px;
}

.calendar-days {
    display: contents;
}

.calendar-day {
    padding: 10px 4px;
    text-align: center;
    border-bottom: 1px solid #f1f3f4;
    border-right: 1px solid #f1f3f4;
    cursor: default;
    transition: all 0.3s ease;
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    font-weight: 500;
}

.calendar-day:nth-child(7n) {
    border-right: none;
}

.calendar-day.other-month {
    color: #cbd5e0;
    background-color: #f8f9fa;
}

.calendar-day.today {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
    transform: scale(1.05);
}

.calendar-day.has-novels {
    background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
    color: #2d3748;
    cursor: pointer;
    position: relative;
    font-weight: 600;
}

.calendar-day.has-novels:hover {
    background: linear-gradient(135deg, #68d391 0%, #4299e1 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(104, 211, 145, 0.4);
}

.calendar-day.has-novels::after {
    content: '';
    position: absolute;
    bottom: 3px;
    right: 3px;
    width: 8px;
    height: 8px;
    background: linear-gradient(135deg, #38a169, #2b6cb0);
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}

.calendar-day.selected {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: bold;
    transform: scale(1.1);
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
    z-index: 10;
}

.calendar-day.selected:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

/* 卡片优化 */
.card {
    border: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
    border-radius: 12px 12px 0 0 !important;
    font-weight: 600;
}

/* 小说列表项优化 */
.list-group-item {
    border: none;
    border-radius: 8px !important;
    margin-bottom: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
}

.list-group-item:hover {
    transform: translateX(4px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}

/* 日期标签美化 */
.badge.bg-light {
    background: linear-gradient(135deg, #e2e8f0, #cbd5e0) !important;
    color: #4a5568 !important;
    font-weight: 500;
    border-radius: 6px;
    padding: 3px 8px;
}

/* 筛选状态优化 */
.bg-light.border-top {
    background: linear-gradient(to right, #edf2f7, #e2e8f0) !important;
    border-top: 2px solid #4299e1 !important;
}

/* 排序控件样式 */
.sort-controls {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 8px 12px;
    border-radius: 12px;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.sort-controls .form-label {
    font-size: 13px;
    font-weight: 600;
    color: #6c757d;
}

#sortDropdown {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border: none;
    color: white;
    font-weight: 500;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
    transition: all 0.3s ease;
    min-width: 120px;
}

#sortDropdown:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
}

#sortDropdown:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.dropdown-menu {
    border: none;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    padding: 8px 0;
    min-width: 220px;
}

.dropdown-header {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    color: #495057;
    font-weight: 600;
    padding: 8px 16px;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 8px;
    margin: 4px 8px;
}

.dropdown-item {
    padding: 10px 16px;
    font-size: 14px;
    border-radius: 8px;
    margin: 2px 8px;
    transition: all 0.2s ease;
}

.dropdown-item:hover {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    color: #1976d2;
    transform: translateX(4px);
}

.dropdown-item.active {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
}

.dropdown-item.active:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
    transform: translateX(0);
}

.dropdown-item i {
    width: 16px;
    margin-right: 8px;
}

.dropdown-divider {
    margin: 8px 16px;
    border-color: #e9ecef;
}

/* 快速排序按钮组 */
.quick-sort-btn {
    border-radius: 8px;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
    background: white;
    width: 36px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quick-sort-btn:hover {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    border-color: #007bff;
    color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
}

.quick-sort-btn.btn-primary {
    background: linear-gradient(135deg, #007bff, #0056b3);
    border-color: #007bff;
    color: white;
    box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
}

.quick-sort-btn.btn-primary:hover {
    background: linear-gradient(135deg, #0056b3, #004085);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
}

.btn-group .quick-sort-btn:first-child {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-group .quick-sort-btn:last-child {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}

.btn-group .quick-sort-btn:not(:first-child):not(:last-child) {
    border-radius: 0;
}

/* 排序状态指示器 */
.sort-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #28a745;
    margin-left: 4px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* 响应式设计 */
@media (max-width: 768px) {
    .sort-controls {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .sort-controls .form-label {
        margin-bottom: 4px;
    }
    
    .quick-sort-btn {
        width: 32px;
        height: 28px;
    }
    
    #sortDropdown {
        min-width: 100px;
        font-size: 13px;
    }
}

/* 原有样式保持不变 */
.star-rating {
    display: flex;
    cursor: pointer;
    font-size: 18px;
    color: #ddd;
    user-select: none;
}

.star-rating .star {
    transition: color 0.2s;
}

.star-rating .star.active {
    color: #ffc107;
}

.star-rating .star:hover {
    color: #ffc107;
}

.star-rating:hover .star {
    color: #ddd;
}

.star-rating:hover .star:hover,
.star-rating:hover .star:hover ~ .star {
    color: #ffc107;
}

/* 已评分状态的特殊样式 */
.star-rating.rated {
    color: #ffc107;
}

.star-rating.rated .star.active {
    color: #ffc107;
}

/* 分类管理样式 */
.category-actions {
    transition: opacity 0.2s;
}

.list-group-item:hover .category-actions {
    opacity: 1 !important;
}

.category-management-mode .category-actions {
    opacity: 1 !important;
}

.category-management-mode .list-group-item {
    border-left: 3px solid #007bff;
}

/* 标题编辑样式 */
.title-container {
    min-width: 0; /* 确保flex项目可以收缩 */
}

.title-edit .input-group {
    max-width: 400px;
}

.edit-title-btn {
    opacity: 0;
    transition: opacity 0.2s;
}

.delete-novel-btn {
    opacity: 0;
    transition: opacity 0.2s;
}

.list-group-item:hover .edit-title-btn,
.list-group-item:hover .delete-novel-btn {
    opacity: 1;
}

.title-input {
    font-size: 1rem;
    font-weight: 500;
}

.title-edit .btn {
    border-radius: 0;
}

.title-edit .btn:first-of-type {
    border-top-right-radius: 0.25rem;
    border-bottom-right-radius: 0.25rem;
}

/* 编辑模式下的特殊样式 */
.title-editing {
    background-color: #f8f9fa;
    border-left: 3px solid #ffc107;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let isManagementMode = false;
let currentDeleteCategoryId = null;

// 日历相关变量
let currentCalendarYear = new Date().getFullYear();
let currentCalendarMonth = new Date().getMonth() + 1; // JavaScript月份从0开始
let calendarData = {};
let selectedDate = null;

document.addEventListener('DOMContentLoaded', function() {
    // 初始化所有评分组件
    initializeRatings();
    
    // 设置星级评分点击事件
    setupRatingEvents();
    
    // 初始化日历
    initializeCalendar();
    
    // 初始化排序功能
    initializeSorting();
});

// === 排序功能 ===

function initializeSorting() {
    // 设置当前排序状态
    const currentSort = '{{ current_sort }}';
    updateSortDisplay(currentSort);
    
    // 绑定下拉菜单排序事件
    document.querySelectorAll('.dropdown-item[data-sort]').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const sortType = this.dataset.sort;
            const sortName = this.dataset.name;
            applySorting(sortType, sortName);
        });
    });
    
    // 绑定快速排序按钮事件
    document.querySelectorAll('.quick-sort-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const sortType = this.dataset.sort;
            const sortName = getSortDisplayName(sortType);
            applySorting(sortType, sortName);
        });
    });
}

function applySorting(sortType, sortName) {
    // 调试输出
    console.log('DEBUG: 应用排序', { sortType, sortName });
    
    // 更新UI显示
    updateSortDisplay(sortType, sortName);
    
    // 构建新的URL
    const url = new URL(window.location);
    url.searchParams.set('sort', sortType);
    url.searchParams.delete('page'); // 重置页码
    
    console.log('DEBUG: 新URL', url.toString());
    
    // 显示加载状态
    showSortingLoader();
    
    // 跳转到新的排序页面
    window.location.href = url.toString();
}

function updateSortDisplay(sortType, sortName = null) {
    const currentSortText = document.getElementById('currentSortText');
    const quickSortBtns = document.querySelectorAll('.quick-sort-btn');
    
    // 更新下拉菜单显示文本
    if (sortName) {
        currentSortText.textContent = sortName;
    } else {
        currentSortText.textContent = getSortDisplayName(sortType);
    }
    
    // 更新快速按钮激活状态
    quickSortBtns.forEach(btn => {
        btn.classList.remove('btn-primary', 'btn-outline-secondary');
        if (btn.dataset.sort === sortType || 
            (btn.dataset.sort === 'created_at' && sortType === 'created_at_asc') ||
            (btn.dataset.sort === 'title' && sortType === 'title_desc') ||
            (btn.dataset.sort === 'rating' && sortType === 'rating_asc')) {
            btn.classList.add('btn-primary');
        } else {
            btn.classList.add('btn-outline-secondary');
        }
    });
    
    // 更新下拉菜单项激活状态
    document.querySelectorAll('.dropdown-item[data-sort]').forEach(item => {
        if (item.dataset.sort === sortType) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
}

function getSortDisplayName(sortType) {
    const sortNames = {
        'created_at': '最新发布',
        'created_at_asc': '最早发布',
        'title': '名称升序',
        'title_desc': '名称降序',
        'rating': '评分最高',
        'rating_asc': '评分最低',
        'user_rating': '我的评分',
        'avg_rating': '平均评分',
        'updated_at': '最近更新'
    };
    return sortNames[sortType] || '最新发布';
}

function showSortingLoader() {
    const sortDropdown = document.getElementById('sortDropdown');
    const originalHtml = sortDropdown.innerHTML;
    
    sortDropdown.innerHTML = `
        <i class="bi bi-hourglass-split me-1"></i>
        <span>排序中...</span>
    `;
    sortDropdown.disabled = true;
    
    // 禁用快速排序按钮
    document.querySelectorAll('.quick-sort-btn').forEach(btn => {
        btn.disabled = true;
    });
}

// === 日历功能 ===

function initializeCalendar() {
    // 如果有当前筛选日期，设置为选中状态
    {% if current_date %}
    selectedDate = '{{ current_date }}';
    const dateObj = new Date('{{ current_date }}');
    currentCalendarYear = dateObj.getFullYear();
    currentCalendarMonth = dateObj.getMonth() + 1;
    {% endif %}
    
    loadCalendarData();
}

function loadCalendarData() {
    fetch(`/api/novel_calendar?year=${currentCalendarYear}&month=${currentCalendarMonth}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                calendarData = data.data;
                renderCalendar();
            } else {
                showMessage('加载日历数据失败', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('网络错误', 'danger');
        });
}

function renderCalendar() {
    const calendarTitle = document.getElementById('calendarTitle');
    const calendarDays = document.getElementById('calendarDays');
    
    // 设置标题
    calendarTitle.textContent = `${currentCalendarYear}年${currentCalendarMonth}月`;
    
    // 清空日历
    calendarDays.innerHTML = '';
    
    // 计算月份的第一天和最后一天
    const firstDay = new Date(currentCalendarYear, currentCalendarMonth - 1, 1);
    const lastDay = new Date(currentCalendarYear, currentCalendarMonth, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay()); // 调整到周日开始
    
    // 生成6周的日期
    for (let week = 0; week < 6; week++) {
        for (let day = 0; day < 7; day++) {
            const currentDate = new Date(startDate);
            currentDate.setDate(startDate.getDate() + week * 7 + day);
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = currentDate.getDate();
            
            const dateStr = currentDate.toISOString().split('T')[0];
            dayElement.dataset.date = dateStr;
            
            // 判断是否为其他月份的日期
            if (currentDate.getMonth() !== firstDay.getMonth()) {
                dayElement.classList.add('other-month');
            }
            
            // 判断是否为今天
            const today = new Date();
            if (currentDate.toDateString() === today.toDateString()) {
                dayElement.classList.add('today');
            }
            
            // 判断是否有小说添加
            if (calendarData[dateStr]) {
                dayElement.classList.add('has-novels');
                dayElement.title = `${calendarData[dateStr]}本小说`;
                dayElement.addEventListener('click', () => showDateDetails(dateStr));
            }
            
            // 判断是否为选中日期
            if (selectedDate === dateStr) {
                dayElement.classList.add('selected');
            }
            
            calendarDays.appendChild(dayElement);
        }
    }
}

function changeMonth(delta) {
    currentCalendarMonth += delta;
    if (currentCalendarMonth > 12) {
        currentCalendarMonth = 1;
        currentCalendarYear++;
    } else if (currentCalendarMonth < 1) {
        currentCalendarMonth = 12;
        currentCalendarYear--;
    }
    loadCalendarData();
}

function showDateDetails(dateStr) {
    selectedDate = dateStr;
    document.getElementById('modalDateTitle').textContent = dateStr;
    
    // 显示加载状态
    document.getElementById('dateNovelsLoading').classList.remove('d-none');
    document.getElementById('dateNovelsList').classList.add('d-none');
    document.getElementById('dateNovelsEmpty').classList.add('d-none');
    
    const modal = new bootstrap.Modal(document.getElementById('dateDetailModal'));
    modal.show();
    
    // 加载该日期的小说列表
    fetch(`/api/novels_by_date?date=${dateStr}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('dateNovelsLoading').classList.add('d-none');
            
            if (data.success && data.novels.length > 0) {
                const novelsList = document.getElementById('dateNovelsList');
                novelsList.innerHTML = '';
                
                data.novels.forEach(novel => {
                    const novelElement = document.createElement('div');
                    novelElement.className = 'list-group-item list-group-item-action';
                    novelElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${novel.title}</h6>
                                <small class="text-muted">${novel.category} • ${novel.created_at}</small>
                            </div>
                            <small class="text-muted">${novel.author}</small>
                        </div>
                    `;
                    novelElement.addEventListener('click', () => {
                        window.location.href = `/novel/${novel.id}`;
                    });
                    novelsList.appendChild(novelElement);
                });
                
                novelsList.classList.remove('d-none');
            } else {
                document.getElementById('dateNovelsEmpty').classList.remove('d-none');
            }
        })
        .catch(error => {
            document.getElementById('dateNovelsLoading').classList.add('d-none');
            console.error('Error:', error);
            showMessage('加载数据失败', 'danger');
        });
    
    // 更新日历显示
    renderCalendar();
}

function filterByModalDate() {
    if (selectedDate) {
        const url = new URL(window.location);
        url.searchParams.set('date', selectedDate);
        url.searchParams.delete('page'); // 重置页码
        window.location.href = url.toString();
    }
}

// === 小说删除功能 ===

let currentDeleteNovelId = null;

function confirmDeleteNovel(novelId, novelTitle) {
    currentDeleteNovelId = novelId;
    
    // 设置模态框内容
    document.getElementById('deleteNovelTitle').textContent = novelTitle;
    document.getElementById('deleteNovelId').textContent = novelId;
    
    // 重置确认输入框
    const confirmInput = document.getElementById('confirmInput');
    confirmInput.value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
    
    // 监听确认输入
    confirmInput.oninput = function() {
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        if (this.value.trim() === '确认删除') {
            deleteBtn.disabled = false;
            deleteBtn.classList.remove('btn-danger');
            deleteBtn.classList.add('btn-danger');
        } else {
            deleteBtn.disabled = true;
        }
    };
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('deleteNovelModal'));
    modal.show();
    
    // 聚焦到确认输入框
    setTimeout(() => {
        confirmInput.focus();
    }, 500);
}

function executeDeleteNovel() {
    if (!currentDeleteNovelId) return;
    
    const confirmInput = document.getElementById('confirmInput');
    if (confirmInput.value.trim() !== '确认删除') {
        showMessage('请正确输入确认文字', 'warning');
        return;
    }
    
    // 禁用删除按钮防止重复提交
    const deleteBtn = document.getElementById('confirmDeleteBtn');
    const originalBtnHtml = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="bi bi-hourglass me-1"></i>删除中...';
    
    fetch('/api/delete_novel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            novel_id: currentDeleteNovelId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteNovelModal'));
            modal.hide();
            
            // 从页面中移除小说项
            const novelItem = document.querySelector(`[data-novel-id="${currentDeleteNovelId}"]`);
            if (novelItem) {
                const listGroupItem = novelItem.closest('.list-group-item');
                if (listGroupItem) {
                    // 添加淡出动画
                    listGroupItem.style.transition = 'opacity 0.3s ease-out';
                    listGroupItem.style.opacity = '0';
                    
                    setTimeout(() => {
                        listGroupItem.remove();
                        
                        // 检查是否还有小说，如果没有显示空状态
                        const remainingNovels = document.querySelectorAll('.list-group-item');
                        if (remainingNovels.length === 0) {
                            location.reload(); // 重新加载页面以显示正确的状态
                        }
                    }, 300);
                }
            }
            
            showMessage(`小说 "${data.deleted_novel.title}" 删除成功！`, 'success');
        } else {
            showMessage(data.message || '删除失败', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('网络错误', 'danger');
    })
    .finally(() => {
        // 恢复删除按钮
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalBtnHtml;
        currentDeleteNovelId = null;
    });
}

// === 标题编辑功能 ===

function editNovelTitle(novelId) {
    const container = document.querySelector(`[data-novel-id="${novelId}"]`);
    if (!container) return;
    
    const displayElement = container.querySelector('.title-display');
    const editElement = container.querySelector('.title-edit');
    const editButton = container.closest('.list-group-item').querySelector('.edit-title-btn');
    const listItem = container.closest('.list-group-item');
    
    // 切换到编辑模式
    displayElement.classList.add('d-none');
    editElement.classList.remove('d-none');
    editButton.classList.add('d-none');
    listItem.classList.add('title-editing');
    
    // 聚焦到输入框
    const input = editElement.querySelector('.title-input');
    input.focus();
    input.select();
    
    // 添加回车键保存功能
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            saveNovelTitle(novelId);
        } else if (e.key === 'Escape') {
            cancelTitleEdit(novelId);
        }
    });
}

function cancelTitleEdit(novelId) {
    const container = document.querySelector(`[data-novel-id="${novelId}"]`);
    if (!container) return;
    
    const displayElement = container.querySelector('.title-display');
    const editElement = container.querySelector('.title-edit');
    const editButton = container.closest('.list-group-item').querySelector('.edit-title-btn');
    const listItem = container.closest('.list-group-item');
    const input = editElement.querySelector('.title-input');
    
    // 恢复原始标题
    const originalTitle = displayElement.querySelector('a').textContent.trim();
    input.value = originalTitle;
    
    // 切换回显示模式
    displayElement.classList.remove('d-none');
    editElement.classList.add('d-none');
    editButton.classList.remove('d-none');
    listItem.classList.remove('title-editing');
}

function saveNovelTitle(novelId) {
    const container = document.querySelector(`[data-novel-id="${novelId}"]`);
    if (!container) return;
    
    const input = container.querySelector('.title-input');
    const newTitle = input.value.trim();
    
    if (!newTitle) {
        showMessage('标题不能为空', 'warning');
        return;
    }
    
    // 禁用保存按钮防止重复提交
    const saveBtn = container.querySelector('.save-title-btn');
    const originalSaveBtnHtml = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="bi bi-hourglass"></i>';
    
    fetch('/api/update_novel_title', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            novel_id: novelId,
            title: newTitle
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新显示的标题
            const titleLink = container.querySelector('.title-display a');
            titleLink.textContent = newTitle;
            
            // 退出编辑模式
            cancelTitleEdit(novelId);
            
            showMessage('标题更新成功！', 'success');
        } else {
            showMessage(data.message || '更新失败', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('网络错误', 'danger');
    })
    .finally(() => {
        // 恢复保存按钮
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalSaveBtnHtml;
    });
}

// === 分类管理功能 ===

function showCategoryManager() {
    isManagementMode = !isManagementMode;
    const categoryList = document.getElementById('categoryList');
    const manageButton = event.target.closest('button');
    
    if (isManagementMode) {
        categoryList.classList.add('category-management-mode');
        manageButton.innerHTML = '<i class="bi bi-x-circle"></i> 退出';
        manageButton.className = 'btn btn-outline-secondary btn-sm';
        
        // 显示所有编辑按钮
        document.querySelectorAll('.category-actions').forEach(action => {
            action.classList.remove('d-none');
        });
    } else {
        categoryList.classList.remove('category-management-mode');
        manageButton.innerHTML = '<i class="bi bi-gear-fill"></i> 管理';
        manageButton.className = 'btn btn-outline-primary btn-sm';
        
        // 隐藏所有编辑按钮
        document.querySelectorAll('.category-actions').forEach(action => {
            action.classList.add('d-none');
        });
    }
}

function showAddCategoryForm() {
    document.getElementById('categoryModalTitle').textContent = '添加新分类';
    document.getElementById('categoryId').value = '';
    document.getElementById('categoryName').value = '';
    document.getElementById('categoryDescription').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
    modal.show();
}

function editCategory(categoryId, categoryName, categoryDescription) {
    document.getElementById('categoryModalTitle').textContent = '编辑分类';
    document.getElementById('categoryId').value = categoryId;
    document.getElementById('categoryName').value = categoryName;
    document.getElementById('categoryDescription').value = categoryDescription || '';
    
    const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
    modal.show();
}

function deleteCategory(categoryId, categoryName) {
    currentDeleteCategoryId = categoryId;
    document.getElementById('deleteCategoryName').textContent = categoryName;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    modal.show();
}

function saveCategoryForm() {
    const form = document.getElementById('categoryForm');
    const formData = new FormData(form);
    const categoryId = formData.get('categoryId');
    const categoryName = formData.get('categoryName').trim();
    const categoryDescription = formData.get('categoryDescription').trim();
    
    if (!categoryName) {
        showMessage('分类名称不能为空', 'warning');
        return;
    }
    
    const isEdit = categoryId && categoryId !== '';
    const url = isEdit ? '/api/update_category' : '/api/add_category';
    const data = {
        name: categoryName,
        description: categoryDescription
    };
    
    if (isEdit) {
        data.category_id = parseInt(categoryId);
    }
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage(isEdit ? '分类更新成功！' : '分类添加成功！', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
            modal.hide();
            
            // 刷新页面以显示更新后的分类
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMessage(data.message || '操作失败', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('网络错误', 'danger');
    });
}

function confirmDeleteCategory() {
    if (!currentDeleteCategoryId) return;
    
    fetch('/api/delete_category', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            category_id: currentDeleteCategoryId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('分类删除成功！', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
            modal.hide();
            
            // 刷新页面以显示更新后的分类
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMessage(data.message || '删除失败', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('网络错误', 'danger');
    });
}

// === 评分功能（保持原有） ===

function initializeRatings() {
    document.querySelectorAll('.star-rating').forEach(rating => {
        const currentRating = parseInt(rating.dataset.rating) || 0;
        updateStarDisplay(rating, currentRating);
    });
}

function setupRatingEvents() {
    document.querySelectorAll('.star-rating').forEach(rating => {
        const stars = rating.querySelectorAll('.star');
        const novelId = rating.dataset.novelId;
        
        stars.forEach(star => {
            star.addEventListener('click', function() {
                const ratingValue = parseInt(this.dataset.value);
                submitRating(novelId, ratingValue, rating);
            });
            
            star.addEventListener('mouseenter', function() {
                const hoverValue = parseInt(this.dataset.value);
                highlightStars(rating, hoverValue);
            });
        });
        
        rating.addEventListener('mouseleave', function() {
            const currentRating = parseInt(rating.dataset.rating) || 0;
            updateStarDisplay(rating, currentRating);
        });
    });
}

function highlightStars(ratingElement, value) {
    const stars = ratingElement.querySelectorAll('.star');
    stars.forEach((star, index) => {
        star.classList.toggle('active', index < value);
    });
}

function updateStarDisplay(ratingElement, value) {
    const stars = ratingElement.querySelectorAll('.star');
    stars.forEach((star, index) => {
        star.classList.toggle('active', index < value);
    });
    
    // 如果已评分，添加特殊样式
    if (value > 0) {
        ratingElement.classList.add('rated');
    } else {
        ratingElement.classList.remove('rated');
    }
}

function submitRating(novelId, rating, ratingElement) {
    fetch('/api/rate_novel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            novel_id: parseInt(novelId),
            rating: rating
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新当前评分
            ratingElement.dataset.rating = rating;
            updateStarDisplay(ratingElement, rating);
            
            // 显示成功消息
            showMessage('评分成功！', 'success');
            
            // 如果当前是按用户评分排序，可能需要刷新页面
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('sort') === 'user_rating') {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        } else {
            showMessage(data.message || '评分失败', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('网络错误', 'danger');
    });
}

function showMessage(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 自动隐藏
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}
</script>
{% endblock %}